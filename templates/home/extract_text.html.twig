{# templates/home/extract_text.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Texto extraído - {{ filename }}{% endblock %}

{% block body %}
<div class="example-wrapper">
    <h1>Texto extraído de: {{ filename }}</h1>
    
    {# Extraction Method Selector #}
    <div class="method-selector card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Método de extração</h5>
        </div>
        <div class="card-body">
            <form method="post" action="{{ path('app_extract_text_method', {'filename': filename}) }}">
                <div class="row">
                    <div class="col-md-8">
                        <select name="method" class="form-select" onchange="this.form.submit()">
                            {% for key, label in availableMethods %}
                                <option value="{{ key }}" {{ currentMethod == key ? 'selected' : '' }}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <span class="badge bg-{{ confidence == 'high' ? 'success' : (confidence == 'medium' ? 'warning' : 'danger') }}">
                            Confiabilidade: {{ confidence|upper }}
                        </span>
                    </div>
                </div>
            </form>
            <small class="text-muted mt-2 d-block">
                Método usado: <strong>{{ methodUsed }}</strong>
            </small>
        </div>
    </div>

    {# Statistics #}
    <div class="stats-row mb-4">
        <div class="row">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3>{{ wordCount }}</h3>
                        <p class="text-muted mb-0">Palavras</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3>{{ textLength }}</h3>
                        <p class="text-muted mb-0">Caracteres</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3>{{ lineCount }}</h3>
                        <p class="text-muted mb-0">Linhas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3>
                            {% if confidence == 'high' %}✅
                            {% elseif confidence == 'medium' %}⚠️
                            {% else %}❌
                            {% endif %}
                        </h3>
                        <p class="text-muted mb-0">Qualidade</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if error %}
        <div class="alert alert-warning">
            <h4>Text Extraction Issue</h4>
            <p>{{ error }}</p>
            {% if confidence == 'none' %}
                <p><strong>Try using the OCR method from the dropdown above for scanned PDFs.</strong></p>
            {% endif %}
        </div>
    {% endif %}

    {% if extractedText is empty %}
        <div class="alert alert-danger">
            <h4>No Text Extracted</h4>
            <p>No text could be extracted from this PDF using the current method.</p>
            <ul>
                <li>Try using a different extraction method from the dropdown</li>
                <li>If this is a scanned PDF, use the OCR method</li>
                <li>The PDF might be image-based or password protected</li>
            </ul>
        </div>
    {% else %}
        {# Action Buttons #}
        <div class="action-buttons mb-4">
            <a href="{{ path('app_download_text', {'filename': filename}) }}?method={{ currentMethod }}" 
               class="btn btn-primary">
                Baixar arquivo de texto
            </a>
            <button onclick="copyToClipboard()" class="btn btn-secondary">
                Cpioar para área de transferência
            </button>
            {% if metadata is not empty %}
                <button onclick="toggleMetadata()" class="btn btn-outline-info">
                    Mostrar metadados
                </button>
            {% endif %}
        </div>

        {# Metadata Panel #}
        {% if metadata is not empty %}
            <div id="metadataPanel" class="card mb-4" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">PDF Metadados</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for key, value in metadata %}
                            <div class="col-md-12 mb-3">
                                <strong>{{ key|title }}:</strong> 
                                <div class="mt-1">
                                    {% if value is iterable %}
                                        {% if value is empty %}
                                            <span class="text-muted">(empty)</span>
                                        {% else %}
                                            <div class="metadata-array">
                                                {% for subkey, subvalue in value %}
                                                    <div class="metadata-item">
                                                        <span class="text-muted">{{ subkey }}:</span>
                                                        {% if subvalue is iterable %}
                                                            <pre class="d-inline"><code>{{ subvalue|json_encode(constant('JSON_PRETTY_PRINT')) }}</code></pre>
                                                        {% else %}
                                                            <span>{{ subvalue }}</span>
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">{{ value }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}

        {# Extracted Text #}
        <div class="extracted-text card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Texto extraído</h5>
                <small class="text-muted">{{ methodUsed }}</small>
            </div>
            <div class="card-body">
                <pre style="white-space: pre-wrap; font-family: inherit; margin: 0; max-height: 600px; overflow-y: auto;">{{ extractedText }}</pre>
            </div>
        </div>
    {% endif %}

    {# Navigation #}
    <div class="navigation-buttons mt-4">
        <a href="{{ path('app_pdf_options', {'filename': filename}) }}" class="btn btn-outline-secondary">
            Back to Options
        </a>
        <a href="{{ path('app_view_pdf', {'filename': filename}) }}" class="btn btn-outline-primary">
            View PDF
        </a>
        <a href="{{ path('app_home') }}" class="btn btn-secondary">
            Upload Another PDF
        </a>
    </div>
</div>

<script>
function copyToClipboard() {
    const text = `{{ extractedText|e('js') }}`;
    navigator.clipboard.writeText(text).then(function() {
        // Show success message
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        button.classList.add('btn-success');
        button.classList.remove('btn-secondary');
        
        setTimeout(function() {
            button.textContent = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-secondary');
        }, 2000);
    }).catch(function(err) {
        alert('Failed to copy text: ' + err);
    });
}

function toggleMetadata() {
    const panel = document.getElementById('metadataPanel');
    const button = event.target;
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        button.textContent = 'Hide Metadata';
    } else {
        panel.style.display = 'none';
        button.textContent = 'Show Metadata';
    }
}
</script>

<style>
.stats-row .card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.stats-row .card h3 {
    margin: 0;
    color: #007bff;
}
.method-selector .badge {
    font-size: 0.9em;
}
.metadata-array {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 10px;
    margin-top: 5px;
}
.metadata-item {
    padding: 2px 0;
    border-bottom: 1px solid #dee2e6;
}
.metadata-item:last-child {
    border-bottom: none;
}
.metadata-item pre {
    display: inline;
    background: transparent;
    border: none;
    padding: 0;
    margin: 0;
    font-size: 0.9em;
}
</style>
{% endblock %}